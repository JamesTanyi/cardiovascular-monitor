<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–æµ‹è¯•ä»ªè¡¨ç›˜</title>
    <!-- å¼•å…¥ Bootstrap ç¾åŒ–ç•Œé¢ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Marked.js ç”¨äºè§£æ Markdown (åŒ…å« Base64 å›¾ç‰‡) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .card { margin-bottom: 20px; }
        .status-pass { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        /* é™åˆ¶å›¾ç‰‡æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ’‘ç ´å¸ƒå±€ */
        .report-content img { max-width: 100%; height: auto; margin: 15px 0; border: 1px solid #eee; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .report-content h2 { font-size: 1.2rem; color: #333; margin-top: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        .report-content ul { padding-left: 1.2rem; }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ©º è¡€å‹ç›‘æµ‹ç³»ç»Ÿ - è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š</h1>
        <a href="/" class="btn btn-outline-primary">è¿”å›é¦–é¡µ</a>
    </div>
    
    {% if not test_results %}
        <div class="alert alert-warning">
            æš‚æ— æµ‹è¯•æ•°æ®ã€‚è¯·å…ˆåœ¨ç»ˆç«¯è¿è¡Œ <code>python multi_user_sim.py</code> ç”Ÿæˆæµ‹è¯•ç»“æœã€‚
        </div>
    {% else %}
        <div class="row">
        {% for res in test_results %}
            <div class="col-md-12">
                <div class="card shadow-sm border-start border-5 {{ 'border-success' if res.passed else 'border-danger' }}">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-dark me-2">{{ res.stage }}</span>
                            <span class="text-muted small">è¾“å…¥: {{ res.sbp }}/{{ res.dbp }} | ç—‡çŠ¶: {{ res.symptoms | join(', ') or 'æ— ' }}</span>
                        </div>
                        <div>
                            {% if res.passed %}
                                <span class="badge bg-success">âœ… é€šè¿‡ (PASSED)</span>
                            {% else %}
                                <span class="badge bg-danger">âŒ å¤±è´¥ (FAILED)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <small class="text-muted">é¢„æœŸé£é™©</small><br>
                                <strong>{{ res.expected_risk | upper }}</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">å®é™…åˆ¤å®š</small><br>
                                <strong class="{{ 'status-pass' if res.passed else 'status-fail' }}">
                                    {{ res.actual_risk | upper }}
                                </strong>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">æ…¢æ€§å¼ åŠ›è¯„åˆ†</small><br>
                                <strong>{{ "%.2f"|format(res.full_analysis.chronic_tension|default(0)) }}</strong>
                            </div>
                        </div>

                        <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                            æŸ¥çœ‹åŒ»ç”ŸæŠ¥å‘Šè¯¦æƒ… (å«åŠ¨åŠ›å­¦æ‘˜è¦ & å›¾è¡¨) ğŸ”½
                        </button>
                        
                        <div class="collapse mt-3" id="collapse{{ loop.index }}">
                            <div class="card card-body bg-white">
                                <!-- è¿™é‡Œçš„ ID ç”¨äº JS æ¸²æŸ“ -->
                                <div id="report-{{ loop.index }}" class="report-content"></div>
                                <script>
                                    // è·å–åç«¯ä¼ æ¥çš„ Markdown æ–‡æœ¬ (ä½¿ç”¨ tojson è‡ªåŠ¨è½¬ä¹‰)
                                    var rawMarkdown = {{ res.full_analysis.doctor | tojson }};
                                    // ä½¿ç”¨ Marked.js æ¸²æŸ“ Markdown ä¸º HTML
                                    document.getElementById('report-{{ loop.index }}').innerHTML = marked.parse(rawMarkdown);
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>