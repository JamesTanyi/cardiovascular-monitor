

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è¡€å‹ç›‘æµ‹">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="apple-touch-icon" href="/static/icon.png">

    <title>è¿œç¨‹è¡€å‹å½•å…¥ (V7-æ‰‹æœºå°¾å·ç‰ˆ)</title>

    <style>
        /* é¡µé¢æ•´ä½“å¸ƒå±€ï¼šé€‚é…æ‰‹æœºå±å¹•ï¼Œå¢åŠ æµç•…æ„Ÿ */
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #f4f4f9; 
            overscroll-behavior-y: contain; /* ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°ï¼Œè®©æ“ä½œæ›´ç¨³ */
        }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; }
        
        /* å…³é”®ï¼šè¾“å…¥æ¡†å­—ä½“è®¾ä¸º 16pxï¼Œå½»åº•è§£å†³ iOS ç‚¹å‡»è¾“å…¥æ¡†é¡µé¢è‡ªåŠ¨æ”¾å¤§çš„é¡½ç–¾ */
        input[type="number"], input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px !important; 
            -webkit-appearance: none; /* ç§»é™¤ç§»åŠ¨ç«¯é»˜è®¤é˜´å½± */
        }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 25px; border: 1px solid #ddd; cursor: pointer; font-size: 14px; }
        
        /* æäº¤æŒ‰é’®ï¼šåŠ å¤§ã€åŠ é«˜ï¼Œé€‚åˆæ‰‹æœºå¤§æ‹‡æŒ‡ç‚¹å‡» */
        button { 
            width: 100%; 
            padding: 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:active { background-color: #0056b3; } /* ç‚¹å‡»æ—¶çš„è§†è§‰åé¦ˆ */
        button:disabled { background-color: #6c757d; cursor: not-allowed; }

        /* ç»“æœä¸å†å²è®°å½• */
        #result { margin-top: 20px; white-space: pre-wrap; background: #fdfdfe; border-left: 5px solid #007bff; padding: 15px; border-radius: 5px; display: none; }
        .toggle-box { text-align: center; margin-top: 15px; display: none; }
        .toggle-btn { display: inline-block; padding: 8px 18px; margin: 0 5px; border: 1px solid #007bff; color: #007bff; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; }
        .toggle-btn.active { background: #007bff; color: white; }
        
        .history-box { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h2>â¤ï¸ è¿œç¨‹è¡€å‹å½•å…¥ (V7)</h2>
        
        <div id="input-area">
            <div class="form-group">
                <label>å—è¯•è€… ID (è¯·è¾“å…¥æ‰‹æœºå4ä½)</label>
                <!-- å…è®¸ç”¨æˆ·è¾“å…¥ï¼Œä¸å†åªè¯» -->
                <input type="text" id="patient_id" value="" placeholder="ä¾‹å¦‚ï¼š5678">
                <small id="pid-hint" style="color:#666;display:block;margin-top:4px;">é¦–æ¬¡ä½¿ç”¨è¯·æ‰‹åŠ¨è¾“å…¥ï¼Œåç»­è‡ªåŠ¨è®°å¿†ã€‚</small>
            </div>
            <div class="form-group">
                <label>æ”¶ç¼©å‹ (é«˜å‹ SBP)</label>
                <input type="number" id="sbp" placeholder="ä¾‹å¦‚ 120">
            </div>
            <div class="form-group">
                <label>èˆ’å¼ å‹ (ä½å‹ DBP)</label>
                <input type="number" id="dbp" placeholder="ä¾‹å¦‚ 80">
            </div>
            <div class="form-group">
                <label>å¿ƒç‡ (HR)</label>
                <input type="number" id="hr" placeholder="ä¾‹å¦‚ 70">
            </div>
            
            <div class="form-group">
                <label>ç—‡çŠ¶ (å¦‚æœ‰è¯·é€‰æ‹©)</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="chest_pain">èƒ¸ç—›</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="chest_tightness">èƒ¸é—·</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="dizzy">å¤´æ™•</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="palpitations">å¿ƒæ‚¸</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="short_breath">å‘¼å¸æ€¥ä¿ƒ</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="severe_headache">å‰§çƒˆå¤´ç—›</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="weakness_one_side">å•ä¾§è‚¢ä½“æ— åŠ›</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="slurred_speech">è¨€è¯­ä¸æ¸…</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="vision_loss">è§†åŠ›ä¸§å¤±</label>
                    <label class="checkbox-item"><input type="checkbox" name="symptoms" value="fatigue">å¼‚å¸¸ç–²åŠ³</label>
                </div>
            </div>

            <button id="submit-btn" type="button" onclick="submitData()">æäº¤å¹¶åˆ†æ</button>
        </div>
        
        <!-- æŠ¥å‘Šç‰ˆæœ¬åˆ‡æ¢æŒ‰é’® -->
        <div id="toggle-area" class="toggle-box">
            <span class="toggle-btn active" onclick="switchReport('user', this)">ğŸ‘¤ å—è¯•è€…ç‰ˆ</span>
            <span class="toggle-btn" onclick="switchReport('family', this)">ğŸ  å®¶å±ç‰ˆ</span>
            <span class="toggle-btn" onclick="switchReport('doctor', this)">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿç‰ˆ</span>
        </div>

        <div id="result"></div>

        <!-- å†å²è®°å½•åŒºåŸŸ -->
        <div id="history-section" class="history-box">
            <h3 style="font-size: 16px; color: #333; margin-bottom: 10px;">ğŸ“ æœ¬æ¬¡æäº¤è®°å½•</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>é«˜å‹</th>
                        <th>ä½å‹</th>
                        <th>å¿ƒç‡</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        <div>

    </div>

    <script>
        var URL_PID = "";
        var LAST_REPORTS = null;

        function initPatientID() {
            var pid = "";
            
            // 1. ä¼˜å…ˆä½¿ç”¨ URL å‚æ•° (å¦‚æœå­˜åœ¨)
            if (URL_PID && typeof URL_PID === 'string' && URL_PID.length > 0) {
                pid = URL_PID;
            } else {
                // 2. å¦åˆ™å°è¯•è¯»å–æœ¬åœ°ç¼“å­˜
                try {
                    pid = localStorage.getItem('bp_user_id');
                } catch(e) {}
                
                // 3. å…¼å®¹ Cookie
                if (!pid) {
                    var match = document.cookie.match(new RegExp('(^| )bp_user_id=([^;]+)'));
                    if (match) pid = match[2];
                }
            }

            var el = document.getElementById('patient_id');
            var hint = document.getElementById('pid-hint');
            if (el) el.value = pid;
            
            if (pid && hint) hint.textContent = 'å½“å‰ ID: ' + pid;
            loadHistory(pid); // åŠ è½½å†å²è®°å½•
        }

        function onReady() {
            initPatientID();
            // å¼ºåˆ¶å¯ç”¨æŒ‰é’®ï¼Œé˜²æ­¢æµè§ˆå™¨ç¼“å­˜äº†ä¹‹å‰çš„ç¦ç”¨çŠ¶æ€
            var btn = document.getElementById('submit-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerText = "æäº¤å¹¶åˆ†æ";
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', onReady);
        } else {
            onReady();
        }
        window.addEventListener('load', onReady);

        // --- å†å²è®°å½•åŠŸèƒ½ ---
        function loadHistory(pid) {
            if (!pid) return;
            var key = 'bp_history_' + pid;
            var list = [];
            try {
                list = JSON.parse(localStorage.getItem(key) || '[]');
            } catch(e) {}

            var section = document.getElementById('history-section');
            var tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            if (list.length > 0) {
                section.style.display = 'block';
                // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
                for (var i = list.length - 1; i >= 0; i--) {
                    var item = list[i];
                    var tr = document.createElement('tr');
                    
                    var d = new Date(item.timestamp);
                    var timeStr = d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
                    
                    tr.innerHTML = '<td>' + timeStr + '</td>' +
                                   '<td>' + item.sbp + '</td>' +
                                   '<td>' + item.dbp + '</td>' +
                                   '<td>' + (item.hr || '-') + '</td>';
                    tbody.appendChild(tr);
                }
            } else {
                section.style.display = 'none';
            }
        }

        function saveToHistory(data) {
            var pid = data.patient_id;
            var key = 'bp_history_' + pid;
            var list = [];
            try { list = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) {}
            list.push(data);
            try { localStorage.setItem(key, JSON.stringify(list)); } catch(e) {}
            loadHistory(pid);
        }

        function switchReport(type, btn) {
            if (!LAST_REPORTS) return;
            var text = LAST_REPORTS[type] || "æš‚æ— å†…å®¹";
            var resultDiv = document.getElementById('result');
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>ï¼Œå¹¶å…è®¸ HTML æ¸²æŸ“ (ç”¨äºæ˜¾ç¤ºå›¾ç‰‡)
            var htmlContent = text.replace(/\n/g, '<br>');
            resultDiv.innerHTML = "<strong>âœ… åˆ†æç»“æœï¼š</strong><br><br>" + htmlContent;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            var all = document.querySelectorAll('.toggle-btn');
            all.forEach(function(b){ b.classList.remove('active'); });
            if (btn) btn.classList.add('active');
        }

        function submitData() {
            var pidInput = document.getElementById('patient_id');
            var pid = pidInput ? pidInput.value.trim() : '';
            if (!pid) {
                alert('è¯·è¾“å…¥æ‰‹æœºå4ä½ä½œä¸ºæ‚¨çš„ç¼–å·ã€‚');
                return;
            }

            var btn = document.getElementById('submit-btn');
            var resultDiv = document.getElementById('result');
            var toggleArea = document.getElementById('toggle-area');

            var sbp = document.getElementById('sbp').value;
            var dbp = document.getElementById('dbp').value;
            var hr = document.getElementById('hr').value;

            if (!sbp || !dbp) {
                alert("è¯·è‡³å°‘è¾“å…¥æ”¶ç¼©å‹å’Œèˆ’å¼ å‹");
                return;
            }

            var symptoms = [];
            var checkboxes = document.querySelectorAll('input[name="symptoms"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                symptoms.push(checkboxes[i].value);
            }

            var data = {
                patient_id: pid,
                sbp: parseInt(sbp),
                dbp: parseInt(dbp),
                hr: hr ? parseInt(hr) : null,
                symptoms: symptoms,
                timestamp: new Date().toISOString(),
                measurement_id: 'web-' + pid + '-' + new Date().getTime()
            };

            // æäº¤æ—¶ä¿å­˜ IDï¼Œç¡®ä¿ä¸‹æ¬¡è‡ªåŠ¨å¡«å……
            try {
                localStorage.setItem('bp_user_id', pid);
                document.cookie = "bp_user_id=" + pid + "; path=/; max-age=31536000";
            } catch(e) {}

            btn.disabled = true;
            btn.innerText = "æäº¤ä¸­...";
            resultDiv.style.display = 'none';
            if(toggleArea) toggleArea.style.display = 'none';

            // ä½¿ç”¨ fetch API
            fetch('/api/v1/measurements', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Server error: " + response.status);
                }
            })
            .then(function(result) {
                var text = "";
                
                resultDiv.style.display = 'block';
                resultDiv.style.backgroundColor = "#e9ecef";
                resultDiv.style.color = "#333";

                if (result.analysis) {
                    LAST_REPORTS = result.analysis;
                    if (toggleArea) toggleArea.style.display = 'block';

                    // --- é»˜è®¤æ˜¾ç¤ºå—è¯•è€…ç‰ˆæŠ¥å‘Š ---
                    // 1. ä¼˜å…ˆè·å–å—è¯•è€…ï¼ˆuserï¼‰ç‰ˆæœ¬çš„æ–‡æœ¬
                    var defaultText = result.analysis.user || result.analysis.family || "æš‚æ— å†…å®¹";
                    var htmlContent = defaultText.replace(/\n/g, '<br>');
                    resultDiv.innerHTML = "<strong>âœ… åˆ†æç»“æœï¼š</strong><br><br>" + htmlContent;

                    // 2. æ‰‹åŠ¨æ›´æ–°æŒ‰é’®é«˜äº®çŠ¶æ€ï¼Œç¡®ä¿â€œå—è¯•è€…ç‰ˆâ€è¢«é€‰ä¸­
                    document.querySelectorAll('.toggle-btn').forEach(function(b) { b.classList.remove('active'); });
                    var userBtn = document.querySelector(".toggle-btn[onclick*='user']");
                    if (userBtn) userBtn.classList.add('active');
                } else {
                    if(toggleArea) toggleArea.style.display = 'none';
                    text = result.message || "æäº¤æˆåŠŸï¼";
                    resultDiv.innerText = "âœ… æäº¤æˆåŠŸï¼š" + text;
                }
                
                // æäº¤æˆåŠŸåä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(data);
            })
            .catch(function(err) {
                resultDiv.innerText = "âŒ æäº¤å¤±è´¥: " + err.message + "\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚";
                resultDiv.style.display = 'block';
                resultDiv.style.backgroundColor = "#f8d7da";
                resultDiv.style.color = "#721c24";
                alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            })
            .finally(function() {
                btn.disabled = false;
                btn.innerText = "æäº¤å¹¶åˆ†æ";
            });
        }
    </script>
</body>
</html>
